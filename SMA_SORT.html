<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>SMA 最佳化系統 - 完整交易明細版</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { background: #f4f7f9; }
        .sidebar { background: #fff; padding: 20px; min-height: 100vh; border-right: 1px solid #ddd; position: sticky; top: 0; }
        .config-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        #mainChart { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 500px; }
        .table-container { border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow-y: auto; }
        .trade-log-height { max-height: 350px; }
        .ranking-height { max-height: 400px; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #f1f3f5 !important; }
        .active-row { background: #cfe2ff !important; font-weight: bold; }
        .sticky-header thead { position: sticky; top: 0; background: #212529; color: white; z-index: 10; }
        .clearance-row { background-color: #fff3cd !important; font-weight: bold; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-3 sidebar">
            <h4 class="mb-4 text-primary">SMA 最佳化引擎</h4>
            <div class="config-section">
                <label class="form-label fw-bold">1. 數據上傳</label>
                <input type="file" id="csvFile" accept=".csv" class="form-control mb-2" />
                <select id="stockSelect" class="form-select" disabled></select>
            </div>
            <div class="config-section">
                <label class="form-label fw-bold">2. 日期篩選</label>
                <div class="mb-2"><small>開始</small><input type="date" id="startDate" class="form-control"></div>
                <div class="mb-2"><small>結束</small><input type="date" id="endDate" class="form-control"></div>
            </div>
            <div class="config-section">
                <label class="form-label fw-bold">3. 搜尋範圍</label>
                <small>最大均線天數 (1-256)</small>
                <input type="number" id="maxP" class="form-control" value="256">
            </div>
            <button id="runBtn" class="btn btn-primary w-100 fw-bold shadow-sm" disabled>開始搜尋最佳參數</button>
            <div id="loader" class="text-center mt-3 d-none">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ms-2 small">正在計算所有組合...</span>
            </div>
        </nav>

        <main class="col-md-9 p-4">
            <div id="mainChart" class="mb-4"></div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">交易詳細明細 (含期末清倉)</h5>
                <div id="summaryStats" class="badge bg-dark p-2">等待計算</div>
            </div>
            <div class="table-container trade-log-height mb-5 shadow-sm">
                <table class="table table-sm mb-0 sticky-header" id="tradeTable">
                    <thead>
                        <tr><th>序號</th><th>日期</th><th>動作</th><th>價格</th><th>股數</th><th>損益 (USD)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h5 class="mb-2 text-primary border-bottom pb-2">Top 20 最佳參數排行</h5>
            <div class="table-container ranking-height shadow-sm">
                <table class="table table-hover table-sm mb-0 sticky-header" id="rankingTable">
                    <thead class="table-primary text-dark">
                        <tr><th>排名</th><th>參數 (S/L)</th><th>最終資產</th><th>MDD (%)</th><th>資金水位</th><th>交易次數</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script>
let fullDates = [];
let fullPrices = [];
let rawCSVData = [];
let headers = [];
let allSMA = {};
const initialCapital = 10000;

document.getElementById('csvFile').addEventListener('change', function(e) {
    Papa.parse(e.target.files[0], {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: function(results) {
            rawCSVData = results.data;
            headers = Object.keys(rawCSVData[0]);
            fullDates = rawCSVData.map(r => r[headers[0]]);
            
            const select = document.getElementById('stockSelect');
            select.innerHTML = headers.slice(1).map(h => `<option value="${h}">${h}</option>`).join('');
            select.disabled = false;
            document.getElementById('runBtn').disabled = false;

            document.getElementById('startDate').value = new Date(fullDates[0]).toISOString().split('T')[0];
            document.getElementById('endDate').value = new Date(fullDates[fullDates.length-1]).toISOString().split('T')[0];
        }
    });
});

function calcSMA(prices, period) {
    let sma = new Array(prices.length).fill(null);
    let sum = 0;
    for (let i = 0; i < prices.length; i++) {
        sum += (prices[i] || 0);
        if (i >= period) sum -= (prices[i - period] || 0);
        if (i >= period - 1) sma[i] = sum / period;
    }
    return sma;
}

document.getElementById('runBtn').addEventListener('click', function() {
    document.getElementById('loader').classList.remove('d-none');
    const stockName = document.getElementById('stockSelect').value;
    const maxP = parseInt(document.getElementById('maxP').value);
    const startD = new Date(document.getElementById('startDate').value);
    const endD = new Date(document.getElementById('endDate').value);

    setTimeout(() => {
        fullPrices = rawCSVData.map(r => {
            let val = r[stockName];
            return (val === null || val === "null" || isNaN(val)) ? NaN : val;
        });
        
        allSMA = {};
        for (let p = 1; p <= maxP; p++) allSMA[p] = calcSMA(fullPrices, p);

        let startIdx = -1, endIdx = -1;
        for (let i = 0; i < fullDates.length; i++) {
            let d = new Date(fullDates[i]);
            if (startIdx === -1 && d >= startD) startIdx = i;
            if (d <= endD) endIdx = i;
        }

        let ranking = [];
        for (let s = 1; s <= maxP; s++) {
            for (let l = 1; l <= maxP; l++) {
                ranking.push(runBacktest(startIdx, endIdx, s, l));
            }
        }

        ranking.sort((a, b) => {
            if (Math.abs(a.finalValue - b.finalValue) > 1e-11) return b.finalValue - a.finalValue;
            let distA = Math.abs(a.s - a.l);
            let distB = Math.abs(b.s - b.l);
            if (distA !== distB) return distB - distA;
            if (a.s !== b.s) return b.s - a.s;
            return b.l - a.l;
        });

        renderRanking(ranking.slice(0, 20), startIdx, endIdx);
        updateDisplay(ranking[0], startIdx, endIdx);
        document.getElementById('loader').classList.add('d-none');
    }, 100);
});

function runBacktest(startIdx, endIdx, s, l) {
    let cash = initialCapital;
    let shares = 0;
    let distributedCapital = 0;
    let firstBuyPrice = 0;
    let hasPosition = false;
    let tradeCount = 0;
    let maxValue = initialCapital;
    let maxDD = 0;
    let sumCapitalLevel = 0;
    let capitalDays = 0;
    
    let tradeLog = [];
    let equityCurve = [];
    const maS = allSMA[s];
    const maL = allSMA[l];

    for (let i = startIdx; i <= endIdx; i++) {
        const price = fullPrices[i];
        if (isNaN(price)) {
            equityCurve.push(equityCurve.length > 0 ? equityCurve[equityCurve.length-1] : cash);
            continue;
        }

        let currentValue = cash + (shares * price);
        if (currentValue > maxValue) maxValue = currentValue;
        let dd = (maxValue - currentValue) / maxValue * 100;
        if (dd > maxDD) maxDD = dd;

        if (hasPosition) {
            let holdingValue = shares * price;
            let purchaseRemainder = distributedCapital - (shares * firstBuyPrice);
            sumCapitalLevel += (holdingValue + purchaseRemainder);
            capitalDays++;
        }

        if (i > 0 && maS[i] && maL[i] && maS[i-1] && maL[i-1]) {
            if (maS[i-1] < maL[i-1] && maS[i] >= maL[i] && !hasPosition) {
                shares = Math.floor(cash / price);
                if (shares > 0) {
                    distributedCapital = cash;
                    firstBuyPrice = price;
                    cash -= (shares * price);
                    hasPosition = true;
                    tradeCount++;
                    tradeLog.push({ date: fullDates[i], action: 'BUY', price: price, shares: shares, profit: '-' });
                }
            } else if (maS[i-1] > maL[i-1] && maS[i] <= maL[i] && hasPosition) {
                const profit = (price - firstBuyPrice) * shares;
                cash += (shares * price);
                tradeLog.push({ date: fullDates[i], action: 'SELL', price: price, shares: shares, profit: profit.toFixed(2) });
                shares = 0;
                hasPosition = false;
                tradeCount++;
            }
        }
        equityCurve.push(cash + (shares * price));
    }

    // --- 修改：期末平倉邏輯，並輸出至明細表 ---
    if (hasPosition) {
        const lastPrice = fullPrices[endIdx];
        const profit = (lastPrice - firstBuyPrice) * shares;
        cash += (shares * lastPrice);
        tradeCount++;
        tradeLog.push({ 
            date: fullDates[endIdx], 
            action: 'CLEAR', // 標註為清倉
            price: lastPrice, 
            shares: shares, 
            profit: profit.toFixed(2) 
        });
    }

    return {
        s, l, finalValue: cash,
        avgCapital: capitalDays > 0 ? sumCapitalLevel / capitalDays : 0,
        tradeCount, maxDD,
        roi: (cash - initialCapital) / initialCapital * 100,
        trades: tradeLog, equity: equityCurve
    };
}

function renderRanking(data, sIdx, eIdx) {
    const tbody = document.querySelector('#rankingTable tbody');
    tbody.innerHTML = data.map((r, i) => `
        <tr class="clickable-row ${i===0?'active-row':''}" onclick="selectRank(this, ${JSON.stringify(r).replace(/"/g, '&quot;')}, ${sIdx}, ${eIdx})">
            <td>${i+1}</td>
            <td>${r.s} / ${r.l}</td>
            <td>$${r.finalValue.toFixed(2)}</td>
            <td class="text-danger">${r.maxDD.toFixed(2)}%</td>
            <td>$${r.avgCapital.toFixed(0)}</td>
            <td>${r.tradeCount} 次</td>
        </tr>
    `).join('');
}

function selectRank(row, data, sIdx, eIdx) {
    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-row'));
    row.classList.add('active-row');
    updateDisplay(data, sIdx, eIdx);
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateDisplay(data, sIdx, eIdx) {
    const dates = fullDates.slice(sIdx, eIdx + 1);
    const prices = fullPrices.slice(sIdx, eIdx + 1);
    const subMaS = allSMA[data.s].slice(sIdx, eIdx + 1);
    const subMaL = allSMA[data.l].slice(sIdx, eIdx + 1);

    const buySignals = data.trades.filter(t => t.action === 'BUY');
    const sellSignals = data.trades.filter(t => t.action === 'SELL' || t.action === 'CLEAR');

    const traces = [
        { x: dates, y: prices, name: '價格', line: {color: '#ccc', width: 1}, yaxis: 'y1' },
        { x: dates, y: subMaS, name: 'Short MA', line: {color: '#f54290'}, yaxis: 'y1' },
        { x: dates, y: subMaL, name: 'Long MA', line: {color: '#f5cb42'}, yaxis: 'y1' },
        { x: buySignals.map(t=>t.date), y: buySignals.map(t=>t.price), mode: 'markers', name: '買入', marker: {symbol:'triangle-up', size:12, color:'#28a745'}, yaxis:'y1' },
        { x: sellSignals.map(t=>t.date), y: sellSignals.map(t=>t.price), mode: 'markers', name: '賣出/清倉', marker: {symbol:'triangle-down', size:12, color:'#dc3545'}, yaxis:'y1' },
        { x: dates, y: data.equity, name: '資產', fill: 'tozeroy', line: {color: '#4caf50'}, yaxis: 'y2' }
    ];

    Plotly.newPlot('mainChart', traces, {
        title: `參數組合：${data.s} / ${data.l}`,
        yaxis: { domain: [0.35, 1], title: '價格' },
        yaxis2: { domain: [0, 0.25], title: '資產', side: 'right' },
        hovermode: 'x unified', margin: { t: 50, b: 30 }
    });

    document.getElementById('summaryStats').textContent = `資產: $${data.finalValue.toFixed(2)} | MDD: ${data.maxDD.toFixed(2)}% | 交易: ${data.tradeCount}次`;
    
    const tbody = document.querySelector('#tradeTable tbody');
    tbody.innerHTML = data.trades.map((t, i) => {
        let actionLabel = t.action === 'BUY' ? '買入' : (t.action === 'CLEAR' ? '期末清倉' : '賣出');
        let rowClass = t.action === 'CLEAR' ? 'clearance-row' : '';
        let colorStyle = t.action === 'BUY' ? '#28a745' : '#dc3545';
        
        return `
            <tr class="${rowClass}" style="color: ${colorStyle}">
                <td>${i+1}</td>
                <td>${t.date}</td>
                <td>${actionLabel}</td>
                <td>$${t.price.toFixed(2)}</td>
                <td>${t.shares}</td>
                <td>${t.profit >= 0 ? '+' + t.profit : t.profit}</td>
            </tr>
        `;
    }).reverse().join('');
}
</script>
</body>
</html>